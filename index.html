<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chess Tracker 2026</title>
  <meta name="description" content="Track your chess matches and analyze your performance over time" />
  <meta name="keywords" content="chess tracker, chess matches, rating tracking, chess analytics" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@600;700&family=Space+Grotesk:wght@600;700&display=swap"
    rel="stylesheet">

  <!-- Styles -->
  <style>
    /* Reset and Base Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #000000;
      min-height: 100vh;
      padding: clamp(1rem, 3vw, 2rem);
      color: #f8f9fa;
    }

    /* Form Container */
    .form-container {
      max-width: clamp(300px, 90vw, 900px);
      margin: 0 auto;
      background: #1a1a1a;
      border-radius: 16px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      padding: clamp(1.25rem, 5cqw, 2.5rem);
      border: 1px solid #2a2a2a;
      container-type: inline-size;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .form-container:hover {
      border-color: #3a3a3a;
      transform: translateY(-2px);
    }

    /* Typography */
    h1 {
      font-family: 'Space Grotesk', sans-serif;
      color: #f8f9fa;
      text-align: center;
      margin-bottom: clamp(0.5rem, 3cqh, 1rem);
      font-size: clamp(1.1rem, 6cqw, 3rem);
      font-weight: 700;
      line-height: 1.2;
      letter-spacing: 0.02em;
      text-transform: uppercase;
      white-space: nowrap;
    }

    .subtitle {
      font-family: 'Inter', sans-serif;
      text-align: center;
      color: rgba(248, 249, 250, 0.7);
      margin-bottom: clamp(1.5rem, 3cqh, 2rem);
      font-size: clamp(0.9rem, 3cqw, 1rem);
      font-weight: 500;
      transition: font-size 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Form Elements */
    .form-group {
      margin-bottom: clamp(1rem, 3cqh, 1.5rem);
      position: relative;
    }

    label {
      display: block;
      margin-bottom: clamp(0.25rem, 1.5cqh, 0.5rem);
      font-weight: 600;
      color: #f8f9fa;
      font-size: clamp(0.85rem, 2.5cqw, 0.9rem);
      line-height: 1.5;
      letter-spacing: -0.01em;
    }

    input[type='text'],
    input[type='number'],
    textarea {
      width: 100%;
      padding: clamp(0.625rem, 2.5cqh, 0.75rem) clamp(0.75rem, 3cqw, 1rem);
      border: 1px solid #2a2a2a;
      border-radius: 10px;
      font-size: clamp(0.9rem, 3.5cqw, 1rem);
      font-family: 'Inter', sans-serif;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      background: #000000;
      color: #f8f9fa;
    }

    select {
      width: 100%;
      padding: clamp(0.625rem, 2.5cqh, 0.75rem) clamp(0.75rem, 3cqw, 1rem);
      border: 1px solid #2a2a2a;
      border-radius: 10px;
      font-size: clamp(0.9rem, 3.5cqw, 1rem);
      font-family: 'Inter', sans-serif;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      background: #000000;
      color: #f8f9fa;
    }

    /* Custom File Input Styling */
    input[type='file'] {
      width: 100%;
      padding: clamp(0.625rem, 2.5cqh, 0.75rem) clamp(0.75rem, 3cqw, 1rem);
      border: 1px solid #2a2a2a;
      border-radius: 10px;
      font-size: clamp(0.9rem, 3.5cqw, 1rem);
      font-family: 'Inter', sans-serif;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      background: #000000;
      color: #f8f9fa;
      cursor: pointer;
    }

    input[type='file']:hover {
      border-color: #3a3a3a;
      transform: translateY(-2px);
    }

    input[type='file']:focus {
      outline: none;
      border-color: #7c3aed;
      box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2);
    }

    /* Style the file input button */
    input[type='file']::file-selector-button {
      background: #7c3aed;
      color: white;
      border: none;
      padding: clamp(0.375rem, 1.5cqh, 0.5rem) clamp(0.625rem, 2.5cqw, 0.75rem);
      border-radius: 8px;
      margin-right: clamp(0.5rem, 2cqw, 0.75rem);
      cursor: pointer;
      font-size: clamp(0.8rem, 3cqw, 0.875rem);
      font-weight: 600;
      font-family: 'Inter', sans-serif;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    input[type='file']::file-selector-button:hover {
      background: #6d28d9;
      transform: translateY(-2px);
    }

    input[type='text']:focus,
    input[type='number']:focus,
    textarea:focus {
      outline: none;
      border-color: #7c3aed;
      box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2);
      transform: translateY(-2px);
    }

    input[type='text']:hover,
    input[type='number']:hover,
    textarea:hover,
    select:hover {
      border-color: #3a3a3a;
    }

    select:focus {
      outline: none;
      border-color: #7c3aed;
      box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2);
      transform: translateY(-2px);
    }

    textarea {
      resize: vertical;
      min-height: 80px;
    }

    /* Time Limit Container */
    .time-limit-container {
      display: flex;
      align-items: center;
      gap: clamp(.5px, 1cqw, 6px);
      width: 100%;
    }

    .time-limit-container select {
      flex: 1;
      min-width: 0;
      padding: clamp(0.625rem, 2.5cqh, 0.75rem) clamp(0.5rem, 2cqw, 0.75rem);
      text-align: center;
      box-sizing: border-box;
      font-size: clamp(0.9rem, 3.5cqw, 1rem);
    }

    .time-limit-container select:first-child {
      flex: 1;
      min-width: 64px;
    }

    .time-limit-container select:last-child {
      flex: 1;
      min-width: 64px;
    }

    .time-separator {
      font-weight: bold;
      font-size: clamp(0.9rem, 3.5cqw, 1rem);
      color: #f8f9fa;
      /* remove extra horizontal padding so nearby selects get more width on narrow screens */
      padding: 0;
      flex-shrink: 0;
    }

    /* Two Column Layout */
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: clamp(10px, 3cqw, 20px);
      align-items: start;
    }

    /* Force specific positioning for optional Other Player fields
   so the black player input always occupies the second column. */
    #otherWhiteGroup {
      grid-column: 1 / 2;
    }

    #otherBlackGroup {
      grid-column: 2 / 3;
    }

    /* Checkbox Container */
    .checkbox-container {
      display: flex;
      align-items: center;
      gap: clamp(0.375rem, 1.5cqw, 0.5rem);
      padding: clamp(0.5rem, 2cqh, 0.625rem);
      background: #000000;
      border: 1px solid #2a2a2a;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .checkbox-container:hover {
      background: #1a1a1a;
      border-color: #3a3a3a;
      transform: translateY(-2px);
    }

    .checkbox-container input[type='checkbox'] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: #7c3aed;
    }

    .checkbox-container label {
      margin: 0;
      cursor: pointer;
      user-select: none;
      font-size: clamp(0.85rem, 2.2cqw, 0.9rem);
      font-weight: 500;
      color: #f8f9fa;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Mulligan Section Layout */
    .mulligan-container {
      display: flex;
      flex-direction: column;
      gap: clamp(4px, 1.5vw, 6px);
    }

    /* Result Radio Buttons */
    .result-group {
      display: flex;
      gap: clamp(0.5rem, 2.5cqw, 0.75rem);
      margin-top: clamp(0.375rem, 1.5cqh, 0.625rem);
      flex-wrap: wrap;
    }

    .result-option {
      display: flex;
      align-items: center;
      padding: clamp(0.625rem, 2.5cqh, 0.75rem) clamp(1rem, 4cqw, 1.25rem);
      background: #000000;
      border: 1px solid #2a2a2a;
      border-radius: 10px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      cursor: pointer;
      flex: 1;
      min-width: clamp(80px, 20cqw, 100px);
      justify-content: center;
    }

    .result-option:hover {
      background: #1a1a1a;
      border-color: #3a3a3a;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    .result-option input[type='radio'] {
      width: 18px;
      height: 18px;
      margin-right: clamp(0.375rem, 1.5cqw, 0.5rem);
      cursor: pointer;
      accent-color: #7c3aed;
    }

    .result-option span {
      cursor: pointer;
      user-select: none;
      font-weight: 600;
      font-size: clamp(0.875rem, 2.5cqw, 0.95rem);
      color: #f8f9fa;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .result-option:has(input:checked) {
      background: rgba(124, 58, 237, 0.15);
      border-color: #7c3aed;
      border-width: 2px;
    }

    .result-option.win:has(input:checked) {
      background: rgba(16, 185, 129, 0.15);
      border-color: #10b981;
      border-width: 2px;
    }

    .result-option.loss:has(input:checked) {
      background: rgba(239, 68, 68, 0.15);
      border-color: #ef4444;
      border-width: 2px;
    }

    .result-option.draw:has(input:checked) {
      background: rgba(107, 114, 128, 0.15);
      border-color: #6b7280;
      border-width: 2px;
    }

    /* Help Text Bubble */
    .help-text {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: #1a1a1a;
      border: 1px solid #2a2a2a;
      color: rgba(248, 249, 250, 0.9);
      padding: clamp(0.375rem, 1.5cqh, 0.5rem) clamp(0.625rem, 2.5cqw, 0.75rem);
      border-radius: 8px;
      font-size: clamp(0.75rem, 2cqw, 0.8rem);
      font-family: 'Inter', sans-serif;
      white-space: nowrap;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      margin-bottom: clamp(0.375rem, 1.5cqh, 0.5rem);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
    }

    .help-text::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 5px solid transparent;
      border-top-color: #1a1a1a;
    }

    .help-text.show {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(-5px);
    }

    .help-text.error {
      background: #ef4444;
      border-color: #dc2626;
      color: white;
    }

    .help-text.error::after {
      border-top-color: #ef4444;
    }

    .form-group:hover .help-text:not(.error) {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(-5px);
    }

    /* Slider Styles */
    .slider-container {
      position: relative;
      margin: clamp(0.75rem, 3cqh, 1.25rem) 0;
    }

    .slider-labels {
      display: flex;
      justify-content: space-between;
      margin-bottom: clamp(0.375rem, 1.5cqh, 0.625rem);
      font-size: clamp(0.8rem, 2.2cqw, 0.875rem);
      color: rgba(248, 249, 250, 0.7);
      font-family: 'Inter', sans-serif;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .slider-labels .gentle {
      color: #10b981;
      font-weight: 600;
    }

    .slider-labels .brutal {
      color: #ef4444;
      font-weight: 600;
    }

    input[type='range'] {
      width: 100%;
      height: 6px;
      border-radius: 3px;
      background: linear-gradient(to right, #f59e0b 0%, #f97316 25%, #ef4444 50%, #dc2626 75%, #991b1b 100%);
      outline: none;
      appearance: none;
      -webkit-appearance: none;
    }

    input[type='range']::-webkit-slider-thumb {
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #f8f9fa;
      border: 2px solid #7c3aed;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    input[type='range']::-webkit-slider-thumb:hover {
      transform: scale(1.15);
      box-shadow: 0 4px 12px rgba(124, 58, 237, 0.4);
      border-width: 3px;
    }

    input[type='range']::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #f8f9fa;
      border: 2px solid #7c3aed;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
    }

    .slider-value {
      text-align: center;
      margin-top: clamp(0.375rem, 1.5cqh, 0.625rem);
      font-weight: 700;
      font-family: 'JetBrains Mono', monospace;
      color: #f8f9fa;
      font-size: clamp(0.95rem, 2.8cqw, 1.05rem);
      letter-spacing: -0.01em;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Submit Button */
    .submit-btn {
      width: 100%;
      padding: clamp(0.75rem, 3cqh, 1rem);
      background: linear-gradient(135deg, #00d4ff 0%, #7c3aed 50%, #10b981 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: clamp(1rem, 3.2cqw, 1.1rem);
      font-weight: 700;
      font-family: 'Space Grotesk', sans-serif;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      margin-top: clamp(1.5rem, 3cqh, 2rem);
      box-shadow: 0 4px 6px rgba(124, 58, 237, 0.3);
    }

    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 12px rgba(124, 58, 237, 0.5);
      filter: brightness(1.1);
    }

    .submit-btn:active {
      transform: translateY(0);
    }

    .submit-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      body {
        padding: 10px;
        min-height: 100vh;
      }

      .form-container {
        padding: 20px;
        border-radius: 12px;
      }

      h1 {
        font-size: 2em;
        margin-bottom: 12px;
      }

      label {
        font-size: 0.95em;
      }

      .result-group {
        flex-direction: column;
      }

      .result-option {
        min-width: auto;
      }
    }

    @media (max-width: 600px) {
      .form-container {
        padding: 15px;
      }

      h1 {
        font-size: 1.8em;
        margin-bottom: 10px;
      }

      label {
        font-size: 0.9em;
      }
    }

    /* Very small screens - maintain 2 columns down to 299px */
    @media (max-width: 500px) {
      .form-row {
        grid-template-columns: 1fr 1fr;
        gap: clamp(4px, 2vw, 8px);
      }

      body {
        padding: clamp(2px, 1vw, 10px);
      }

      .form-container {
        padding: clamp(6px, 2vw, 10px);
      }

      h1 {
        font-size: clamp(1.3em, 5vw, 1.6em);
        margin-bottom: 10px;
        font-weight: 700;
      }

      .form-group {
        margin-bottom: clamp(12px, 3vw, 18px);
      }

      label {
        font-size: clamp(0.85em, 2.8vw, 0.95em);
        margin-bottom: 6px;
        font-weight: 600;
      }

      input[type='text'],
      input[type='number'],
      textarea,
      select {
        padding: clamp(6px, 2vw, 8px) clamp(8px, 2.5vw, 10px);
        font-size: clamp(13px, 3.5vw, 14px);
      }

      .checkbox-container {
        padding: clamp(4px, 1.5vw, 6px) clamp(6px, 2vw, 8px);
      }

      .submit-btn {
        padding: clamp(10px, 3vw, 12px);
        font-size: clamp(0.9em, 3vw, 1em);
        margin-top: 10px;
      }

      .help-text {
        font-size: clamp(0.65em, 2vw, 0.7em);
      }

      .slider-container {
        margin: 10px 0;
      }

      .slider-value {
        font-size: clamp(0.85em, 2.5vw, 0.95em);
        margin-top: 6px;
      }
    }

    /* Optimize for 300px - remove wasted space */
    @media (max-width: 350px) {
      body {
        padding: 0;
        margin: 0;
      }

      .form-container {
        padding: 8px;
        border-radius: 0;
        margin: 0;
        width: 100%;
        box-sizing: border-box;
      }

      h1 {
        font-size: 1.5em;
        margin-bottom: 12px;
        font-weight: 700;
        width: 100%;
      }

      label {
        font-size: 0.9em;
        margin-bottom: 6px;
        font-weight: 600;
      }

      .form-group {
        margin-bottom: 15px;
      }

      /* Make venue narrower with consistent height */
      #venue {
        max-width: none;
        width: 100%;
        font-size: 12px;
        padding: 8px 6px;
        box-sizing: border-box;
      }

      /* Consistent height for all selects at 300px */
      select {
        padding: 8px 6px;
        box-sizing: border-box;
      }

    }

    /* Single column only below 299px */
    @media (max-width: 299px) {
      .form-row {
        grid-template-columns: 1fr;
        gap: clamp(8px, 3vw, 10px);
      }
    }

    /* Select dropdown options */
    select option {
      background: #1a1a1a;
      color: #f8f9fa;
    }

    /* Ensure Mulligan checkboxes remain two columns and match selects */
    .mulligan-checkboxes {
      display: grid !important;
      grid-template-columns: repeat(2, 1fr) !important;
      gap: clamp(6px, 2vw, 10px) !important;
      align-items: center !important;
      overflow: visible !important;
    }

    .mulligan-checkboxes .checkbox-container {
      box-sizing: border-box !important;
      height: var(--select-height) !important;
      padding: clamp(0.625rem, 2.5cqh, 0.75rem) clamp(0.75rem, 3cqw, 1rem) !important;
      border-radius: 10px !important;
      border: 1px solid #2a2a2a !important;
      background: #000000 !important;
      display: flex !important;
      align-items: center !important;
      gap: clamp(0.375rem, 1.5cqw, 0.5rem) !important;
      min-width: 0 !important;
    }

    /* Consistent dropdown heights */
    :root {
      --select-height: clamp(40px, 4.2vh, 48px);
    }

    select {
      height: var(--select-height) !important;
      min-height: var(--select-height) !important;
      line-height: var(--select-height) !important;
      box-sizing: border-box;
      padding-top: 0.25rem !important;
      padding-bottom: 0.25rem !important;
    }

    #otherVenue,
    #otherWhitePlayer,
    #otherBlackPlayer {
      width: 100%;
      height: var(--select-height);
      min-height: var(--select-height);
      padding: clamp(0.625rem, 2.5cqh, 0.75rem) clamp(0.75rem, 3cqw, 1rem);
      border: 1px solid #2a2a2a;
      border-radius: 10px;
      background: #000000;
      color: #f8f9fa;
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }

    #otherVenue:focus,
    #otherWhitePlayer:focus,
    #otherBlackPlayer:focus {
      outline: none;
      border-color: #7c3aed;
      box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.2);
      transform: translateY(-2px);
    }

    /* Current Session Display Styles */
    #current-session-container {
      margin-bottom: 20px;
      border-radius: 12px;
      overflow: hidden;
    }

    .session-header {
      background: #7c3aed;
      color: #f8f9fa;
      padding: clamp(12px, 3cqh, 16px);
      user-select: none;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: clamp(10px, 2cqw, 15px);
    }

    .session-header-left {
      cursor: pointer;
      flex: 0 0 auto;
    }

    .session-header-left:hover h3 {
      opacity: 0.9;
    }

    .session-header-right {
      display: flex;
      gap: clamp(8px, 2cqw, 12px);
      align-items: center;
      flex: 1 1 auto;
      justify-content: flex-end;
    }

    #session-selector {
      background: #000000;
      color: #f8f9fa;
      border: 1px solid #2a2a2a;
      padding: clamp(6px, 1.5cqh, 8px) clamp(10px, 2.5cqw, 14px);
      border-radius: 8px;
      cursor: pointer;
      font-size: clamp(0.8rem, 2.3cqw, 0.85rem);
      font-weight: 500;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-family: 'Inter', sans-serif;
      max-width: 200px;
      min-width: 120px;
    }

    #session-selector:hover {
      background: #1a1a1a;
      border-color: #3a3a3a;
    }

    #session-selector:focus {
      outline: none;
      border-color: #7c3aed;
      box-shadow: 0 0 0 2px rgba(124, 58, 237, 0.3);
    }

    .session-content {
      border: 1px solid #2a2a2a;
      border-top: none;
      border-radius: 0 0 12px 12px;
      padding: clamp(12px, 3cqh, 20px);
      background: #1a1a1a;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .session-content.collapsed {
      display: none;
    }

    .stats-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background: #000000;
      border-radius: 8px;
      overflow: hidden;
    }

    .stats-table th,
    .stats-table td {
      padding: clamp(8px, 2cqh, 12px) clamp(8px, 2cqw, 12px);
      text-align: center;
      border: 1px solid #2a2a2a;
      font-size: clamp(0.85rem, 2.5cqw, 0.95rem);
    }

    .stats-table th {
      background: #7c3aed;
      color: #f8f9fa;
      font-weight: 700;
      letter-spacing: 0.02em;
    }

    .stats-table tbody tr:hover {
      background: rgba(124, 58, 237, 0.1);
      transition: background 0.2s;
    }

    .stats-table tbody tr:first-child {
      background: rgba(124, 58, 237, 0.05);
    }

    #refresh-session-btn {
      background: #000000;
      color: #f8f9fa;
      border: 1px solid #2a2a2a;
      padding: clamp(6px, 1.5cqh, 8px) clamp(10px, 2.5cqw, 14px);
      border-radius: 8px;
      cursor: pointer;
      font-size: clamp(0.85rem, 2.5cqw, 0.9rem);
      font-weight: 600;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-family: 'Inter', sans-serif;
    }

    #refresh-session-btn:hover {
      background: #1a1a1a;
      border-color: #3a3a3a;
      transform: translateY(-2px);
    }

    #refresh-session-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    #session-loading,
    #session-no-data,
    #session-error {
      font-size: clamp(0.9rem, 2.8cqw, 1rem);
    }

    #session-loading,
    #session-no-data {
      color: rgba(248, 249, 250, 0.7);
    }

    .session-meta {
      margin-bottom: clamp(10px, 2.5cqh, 15px);
    }

    .session-meta-inline {
      display: flex;
      align-items: center;
      gap: clamp(8px, 2cqw, 12px);
      flex-wrap: wrap;
      font-size: clamp(0.9rem, 2.8cqw, 1rem);
    }

    .session-venue-badge {
      background: rgba(124, 58, 237, 0.2);
      color: #f8f9fa;
      padding: clamp(4px, 1cqh, 6px) clamp(10px, 2.5cqw, 14px);
      border-radius: 6px;
      font-weight: 600;
      border: 1px solid rgba(124, 58, 237, 0.3);
    }

    .session-separator {
      color: rgba(248, 249, 250, 0.4);
      font-weight: bold;
    }

    .session-match-badge {
      color: rgba(248, 249, 250, 0.8);
      font-weight: 500;
    }

    .session-match-badge span {
      color: #7c3aed;
      font-weight: 700;
      font-size: clamp(1rem, 3cqw, 1.1rem);
    }

    @media (max-width: 600px) {
      .stats-table {
        font-size: clamp(0.75rem, 2.2vw, 0.85rem);
      }

      .stats-table th,
      .stats-table td {
        padding: clamp(6px, 1.5vw, 8px) clamp(4px, 1vw, 6px);
      }

      #refresh-session-btn {
        padding: clamp(4px, 1vw, 6px) clamp(8px, 2vw, 10px);
        font-size: clamp(0.75rem, 2vw, 0.85rem);
      }

      #session-selector {
        padding: clamp(4px, 1vw, 6px) clamp(8px, 2vw, 10px);
        font-size: clamp(0.75rem, 2vw, 0.85rem);
        max-width: 140px;
        min-width: 100px;
      }

      .session-header-right {
        gap: clamp(6px, 1.5vw, 8px);
      }

      .session-meta-inline {
        font-size: clamp(0.8rem, 2.5vw, 0.9rem);
        gap: clamp(6px, 1.5vw, 8px);
      }

      .session-venue-badge {
        padding: clamp(3px, 0.8vw, 5px) clamp(8px, 2vw, 10px);
        font-size: clamp(0.8rem, 2.5vw, 0.85rem);
      }
    }
  </style>

  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml"
    href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚ôüÔ∏è</text></svg>" />
</head>

<body>
  <div class="form-container">
    <h1>‚ôüÔ∏è Chess Tracker 2026</h1>
    <p class="subtitle">New and improved with live session tracking</p>

    <!-- Current Session Display -->
    <div id="current-session-container">
      <div class="session-header">
        <div class="session-header-left" onclick="toggleSessionDisplay()">
          <h3 style="margin: 0; font-size: clamp(1rem, 3.5cqw, 1.2rem);">Session Stats</h3>
        </div>
        <div class="session-header-right">
          <select id="session-selector" onchange="onSessionChange()" onclick="event.stopPropagation()">
            <option value="">Current Session</option>
            <!-- Options populated by JavaScript -->
          </select>
          <button type="button" id="refresh-session-btn" onclick="loadCurrentSession(event)">
            Refresh
          </button>
        </div>
      </div>

      <div id="session-content" class="session-content">
        <!-- Loading State -->
        <div id="session-loading" style="text-align: center; padding: 20px; display: none;">
          Loading session data...
        </div>

        <!-- Data Display -->
        <div id="session-data" style="display: none;">
          <div class="session-meta">
            <div class="session-meta-inline">
              <span class="session-venue-badge" id="session-venue">-</span>
              <span class="session-separator">‚Ä¢</span>
              <span class="session-match-badge"><span id="session-match-count">0</span> matches</span>
            </div>
            <span id="session-start-time" style="display: none;"></span>
            <span id="session-duration" style="display: none;"></span>
          </div>

          <div class="session-stats">
            <h4 style="margin-top: 15px; margin-bottom: 10px;">Player Stats:</h4>
            <table id="session-stats-table" class="stats-table">
              <thead>
                <tr>
                  <th>Player</th>
                  <th>M</th>
                  <th>W</th>
                  <th>L</th>
                  <th>D</th>
                  <th>üó°Ô∏è</th>
                  <th>üò≠</th>
                </tr>
              </thead>
              <tbody id="session-stats-body">
                <!-- Populated by JavaScript -->
              </tbody>
            </table>
          </div>

          <div class="session-summary">
            <p id="session-summary-text" style="font-style: italic; color: rgba(248, 249, 250, 0.7); margin-top: 15px; font-size: clamp(0.9rem, 2.8cqw, 0.95rem);">
              <!-- Populated by JavaScript -->
            </p>
          </div>
        </div>

        <!-- No Data State -->
        <div id="session-no-data" style="text-align: center; padding: 20px; color: rgba(248, 249, 250, 0.7); display: none;">
          No active session. Start logging matches to begin a new session!
        </div>

        <!-- Error State -->
        <div id="session-error" style="text-align: center; padding: 20px; color: #ef4444; display: none;">
          Failed to load session data. Please try again.
        </div>
      </div>
    </div>

    <form onsubmit="return handleSubmit(event);" action="javascript:void(0)">
      <!-- Players Row -->
      <div class="form-row">
        <div class="form-group">
          <label for="whitePlayer">‚ôü White Player</label>
          <select id="whitePlayer" name="whitePlayer" required aria-describedby="white-help"
            onchange="toggleOtherPlayer('white', this.value); checkDuplicatePlayers(); updateMulliganLabels();">
            <option value="">White</option>
            <!-- Options populated dynamically from configuration -->
          </select>
          <small id="white-help" class="help-text">Required</small>
        </div>

        <div class="form-group">
          <label for="blackPlayer">‚ôüÔ∏è Black Player</label>
          <select id="blackPlayer" name="blackPlayer" required aria-describedby="black-help"
            onchange="toggleOtherPlayer('black', this.value); checkDuplicatePlayers(); updateMulliganLabels();">
            <option value="">Black</option>
            <!-- Options populated dynamically from configuration -->
          </select>
          <small id="black-help" class="help-text">Required</small>
        </div>
      </div>

      <!-- Other Player Fields (initially hidden) -->
      <div class="form-row" id="otherPlayersRow" style="display: none;">
        <div class="form-group" id="otherWhiteGroup" style="display: none;">
          <label for="otherWhitePlayer">‚ôü White Name</label>
          <input type="text" id="otherWhitePlayer" name="otherWhitePlayer" placeholder="Enter white player name..."
            aria-describedby="other-white-help" maxlength="50"
            oninput="updateWinnerDropdown(); updateMulliganLabels();" />
          <small id="other-white-help" class="help-text">Enter the white player's name.</small>
        </div>

        <div class="form-group" id="otherBlackGroup" style="display: none;">
          <label for="otherBlackPlayer">‚ôüÔ∏è Black Name</label>
          <input type="text" id="otherBlackPlayer" name="otherBlackPlayer" placeholder="Enter black player name..."
            aria-describedby="other-black-help" maxlength="50"
            oninput="updateWinnerDropdown(); updateMulliganLabels();" />
          <small id="other-black-help" class="help-text">Enter the black player's name.</small>
        </div>
      </div>

      <!-- Winner and Match Ending Row -->
      <div class="form-row">
        <div class="form-group">
          <label for="winner">üèÜ Winner</label>
          <select id="winner" name="winner" required aria-describedby="winner-help" onchange="onWinnerChange();">
            <option value="">Winner</option>
            <option value="Draw">Draw</option>
          </select>
          <small id="winner-help" class="help-text">Required</small>
        </div>

        <div class="form-group">
          <label for="gameEnding">üéØ Match Ending</label>
          <select id="gameEnding" name="gameEnding" required aria-describedby="ending-help">
            <option value="">Ending</option>
            <!-- Non-draw endings shown by default; draw-only endings appear when winner === 'Draw' -->
            <option value="Checkmate">Checkmate</option>
            <option value="Resignation">Resignation</option>
            <option value="Time Out">Time Out</option>
          </select>
          <small id="ending-help" class="help-text">Required</small>
        </div>
      </div>

      <!-- Time Limit, Venue, and Mulligan Row -->
      <div class="form-row">
        <div class="form-group">
          <label for="timeLimit">‚è∞ Time Limit</label>
          <div class="time-limit-container">
            <select id="timeLimitMinutes" name="timeLimitMinutes" aria-describedby="time-limit-help">
              <option value="">mm</option>
              <option value="1">01</option>
              <option value="2">02</option>
              <option value="3">03</option>
              <option value="4">04</option>
              <option value="5">05</option>
              <option value="6">06</option>
              <option value="7">07</option>
              <option value="8">08</option>
              <option value="9">09</option>
              <option value="10">10</option>
              <option value="15">15</option>
            </select>
            <span class="time-separator">:</span>
            <select id="timeLimitSeconds" name="timeLimitSeconds" aria-describedby="time-limit-help">
              <option value="">ss</option>
              <option value="0">00</option>
              <option value="5">05</option>
              <option value="10">10</option>
              <option value="15">15</option>
              <option value="20">20</option>
              <option value="30">30</option>
              <option value="45">45</option>
            </select>
          </div>
          <small id="time-limit-help" class="help-text">If timeout</small>
        </div>

        <div class="form-group">
          <label for="venue">üìç Venue</label>
          <select id="venue" name="venue" aria-describedby="venue-help"
            onchange="toggleOtherVenue(this.value); toggleMulliganSection(this.value);">
            <option value="">Venue</option>
            <!-- Options populated dynamically from configuration -->
          </select>
          <small id="venue-help" class="help-text">Optional</small>
        </div>
      </div>

      <!-- Other Venue Field (initially hidden)ut -->
      <div class="form-row" id="otherVenueRow" style="display: none;">
        <div class="form-group" id="otherVenueGroup">
          <label for="otherVenue">üìç Other Venue</label>
          <input type="text" id="otherVenue" name="otherVenue" placeholder="Enter the venue name..."
            aria-describedby="other-venue-help" maxlength="100" />
          <small id="other-venue-help" class="help-text">Enter the name of the venue.</small>
        </div>
      </div>

      <!-- Mulligan Section (initially hidden) -->
      <div class="form-group" id="mulliganSection" style="display: none;">
        <div class="mulligan-container">
          <label>üé≤ Mulligan Used</label>
          <div class="mulligan-checkboxes">
            <div class="checkbox-container" onclick="toggleCheckbox('whiteMulligan')">
              <input type="checkbox" id="whiteMulligan" name="whiteMulligan" onclick="event.stopPropagation();" />
              <label for="whiteMulligan" id="whitePlayerLabel">White Player</label>
            </div>
            <div class="checkbox-container" onclick="toggleCheckbox('blackMulligan')">
              <input type="checkbox" id="blackMulligan" name="blackMulligan" onclick="event.stopPropagation();" />
              <label for="blackMulligan" id="blackPlayerLabel">Black Player</label>
            </div>
          </div>
        </div>
      </div>

      <!-- Brutality Scale -->
      <div class="form-group">
        <label for="brutality">üíÄ Brutality Scale</label>
        <div class="slider-container">
          <div class="slider-labels">
            <span class="gentle">Meh (0)</span>
            <span class="brutal">Brutal (5)</span>
          </div>
          <input type="range" id="brutality" name="brutality" min="0" max="5" value="0"
            aria-describedby="brutality-help" oninput="updateBrutalitySlider(this.value)" />
          <div class="slider-value" id="brutalityValue">Not rated</div>
          <small id="brutality-help" class="help-text">0=Meh, 5=Brutal</small>
        </div>
      </div>


      <!-- Notes -->
      <div class="form-group">
        <label for="notes">üìù Notes</label>
        <textarea id="notes" name="notes" placeholder="Match notes, key moments, brutality insights..."
          aria-describedby="notes-help" maxlength="500"></textarea>
        <small id="notes-help" class="help-text">Insights, key moments</small>
      </div>

      <!-- Picture Upload -->
      <div class="form-group">
        <label for="picture">üì∏ Match Picture</label>
        <input type="file" id="picture" name="picture" accept="image/*" aria-describedby="picture-help" />
        <small id="picture-help" class="help-text">Photo of match/board</small>
      </div>

      <button type="submit" class="submit-btn">Log Match</button>
    </form>
  </div>

  <!-- JavaScript -->
  <script>
    // Global configuration storage
    var appConfig = {
      players: ['Player 1', 'Player 2', 'Player 3'],
      venues: ['Home', 'Park'],
      mulliganVenues: []
    };

    // Load configuration from server on page load
    function loadConfiguration() {
      google.script.run
        .withSuccessHandler(function(config) {
          appConfig = config;
          populatePlayerDropdowns(config.players);
          populateVenueDropdown(config.venues);
          setupMulliganLogic(config.mulliganVenues);
        })
        .withFailureHandler(function(error) {
          console.error('Failed to load configuration:', error);
          // Use default values already in appConfig
          populatePlayerDropdowns(appConfig.players);
          populateVenueDropdown(appConfig.venues);
          setupMulliganLogic(appConfig.mulliganVenues);
        })
        .getConfig();
    }

    // Populate player dropdowns with configured players
    function populatePlayerDropdowns(players) {
      var whiteSelect = document.getElementById('whitePlayer');
      var blackSelect = document.getElementById('blackPlayer');

      // Clear existing options except the first placeholder
      whiteSelect.innerHTML = '<option value="">White</option>';
      blackSelect.innerHTML = '<option value="">Black</option>';

      // Add each configured player
      players.forEach(function(player) {
        var whiteOption = document.createElement('option');
        whiteOption.value = player;
        whiteOption.textContent = player;
        whiteSelect.appendChild(whiteOption);

        var blackOption = document.createElement('option');
        blackOption.value = player;
        blackOption.textContent = player;
        blackSelect.appendChild(blackOption);
      });

      // Always add "Other" option at the end
      var whiteOther = document.createElement('option');
      whiteOther.value = 'Other';
      whiteOther.textContent = 'Other';
      whiteSelect.appendChild(whiteOther);

      var blackOther = document.createElement('option');
      blackOther.value = 'Other';
      blackOther.textContent = 'Other';
      blackSelect.appendChild(blackOther);
    }

    // Populate venue dropdown with configured venues
    function populateVenueDropdown(venues) {
      var venueSelect = document.getElementById('venue');

      // Clear existing options except the first placeholder
      venueSelect.innerHTML = '<option value="">Venue</option>';

      // Add each configured venue
      venues.forEach(function(venue) {
        var option = document.createElement('option');
        option.value = venue;
        option.textContent = venue;
        venueSelect.appendChild(option);
      });

      // Always add "Other" option at the end
      var otherOption = document.createElement('option');
      otherOption.value = 'Other';
      otherOption.textContent = 'Other';
      venueSelect.appendChild(otherOption);
    }

    // Setup mulligan logic based on configured venues
    function setupMulliganLogic(mulliganVenues) {
      // Update the toggleMulliganSection function to use configured venues
      appConfig.mulliganVenues = mulliganVenues;
    }

    // Initialize configuration on page load
    document.addEventListener('DOMContentLoaded', function() {
      loadConfiguration();
    });

    function selectResult(container) {
      var radio = container.querySelector('input[type="radio"]');
      if (event.target.type !== 'radio') {
        radio.checked = true;
      }
    }

    function toggleCheckbox(checkboxId) {
      var checkbox = document.getElementById(checkboxId);
      if (checkbox) {
        checkbox.checked = !checkbox.checked;
      }
    }

    function toggleMulliganSection(venueValue) {
      var mulliganSection = document.getElementById('mulliganSection');
      // Check if venue is in the configured mulligan venues list
      if (appConfig.mulliganVenues.indexOf(venueValue) !== -1) {
        mulliganSection.style.display = 'block';
        updateMulliganLabels();
      } else {
        mulliganSection.style.display = 'none';
        // Reset checkboxes when hiding
        document.getElementById('whiteMulligan').checked = false;
        document.getElementById('blackMulligan').checked = false;
      }
    }

    function updateMulliganLabels() {
      var whitePlayer = document.getElementById('whitePlayer').value;
      var blackPlayer = document.getElementById('blackPlayer').value;
      var whitePlayerLabel = document.getElementById('whitePlayerLabel');
      var blackPlayerLabel = document.getElementById('blackPlayerLabel');

      // Get actual player names
      var whitePlayerName = whitePlayer;
      var blackPlayerName = blackPlayer;

      if (whitePlayer === 'Other') {
        var otherWhiteInput = document.getElementById('otherWhitePlayer');
        whitePlayerName = otherWhiteInput.value.trim() || 'White Player';
      }

      if (blackPlayer === 'Other') {
        var otherBlackInput = document.getElementById('otherBlackPlayer');
        blackPlayerName = otherBlackInput.value.trim() || 'Black Player';
      }

      whitePlayerLabel.textContent = whitePlayerName || 'White Player';
      blackPlayerLabel.textContent = blackPlayerName || 'Black Player';
    }

    function updateBrutalitySlider(value) {
      var display = document.getElementById('brutalityValue');
      var description = '';
      var color = '';

      if (!value || value === '') {
        description = 'Not rated';
        color = '#666';
      } else if (value == 0) {
        description = 'Meh';
        color = '#95a5a6';
      } else if (value == 1) {
        description = 'Spicy';
        color = '#f39c12';
      } else if (value == 2) {
        description = 'Harsh';
        color = '#e67e22';
      } else if (value == 3) {
        description = 'Ruthless';
        color = '#e74c3c';
      } else if (value == 4) {
        description = 'Devastating';
        color = '#c0392b';
      } else {
        description = 'Brutal';
        color = '#8b0000';
      }

      if (value === '' || !value) {
        display.textContent = description;
      } else {
        display.textContent = description + ' (' + value + ')';
      }
      display.style.color = color;
    }

    function toggleOtherVenue(value) {
      var otherVenueRow = document.getElementById('otherVenueRow');
      var otherVenueField = document.getElementById('otherVenue');

      if (value === 'Other') {
        otherVenueRow.style.display = 'grid';
        otherVenueField.required = true;
      } else {
        otherVenueRow.style.display = 'none';
        otherVenueField.required = false;
        otherVenueField.value = '';
      }
    }

    function toggleOtherPlayer(playerType, value) {
      var otherPlayersRow = document.getElementById('otherPlayersRow');
      var otherWhiteGroup = document.getElementById('otherWhiteGroup');
      var otherBlackGroup = document.getElementById('otherBlackGroup');
      var otherWhiteField = document.getElementById('otherWhitePlayer');
      var otherBlackField = document.getElementById('otherBlackPlayer');

      if (playerType === 'white') {
        if (value === 'Other') {
          otherPlayersRow.style.display = 'grid';
          otherWhiteGroup.style.display = 'block';
          otherWhiteField.required = true;
        } else {
          otherWhiteGroup.style.display = 'none';
          otherWhiteField.required = false;
          otherWhiteField.value = '';
          // Hide row if both are hidden
          if (otherBlackGroup.style.display === 'none') {
            otherPlayersRow.style.display = 'none';
          }
        }
      } else if (playerType === 'black') {
        if (value === 'Other') {
          otherPlayersRow.style.display = 'grid';
          otherBlackGroup.style.display = 'block';
          otherBlackField.required = true;
        } else {
          otherBlackGroup.style.display = 'none';
          otherBlackField.required = false;
          otherBlackField.value = '';
          // Hide row if both are hidden
          if (otherWhiteGroup.style.display === 'none') {
            otherPlayersRow.style.display = 'none';
          }
        }
      }

      // Check for duplicate players after selection change
      checkDuplicatePlayers();
      // Update winner dropdown when players change
      updateWinnerDropdown();
    }

    /* Title responsiveness: remove emoji at very small widths (no media queries) */
    (function () {
      function updateTitleEmoji() {
        var container = document.querySelector('.form-container');
        var h1 = container ? container.querySelector('h1') : document.querySelector('h1');
        if (!h1) return;

        // Preserve original text once
        if (!h1.dataset.origText) h1.dataset.origText = h1.textContent;
        var orig = h1.dataset.origText;

        var width = container ? container.clientWidth : window.innerWidth;

        if (width <= 300) {
          // Remove a single leading emoji (including optional variation selector) and one following space
          var stripped = orig.replace(/^[\u{1F300}-\u{1F6FF}\u{1F900}-\u{1F9FF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}]\uFE0F?\s?/u, '');
          h1.textContent = stripped;
        } else {
          h1.textContent = orig;
        }
      }

      window.addEventListener('resize', updateTitleEmoji);
      document.addEventListener('DOMContentLoaded', function () {
        setTimeout(updateTitleEmoji, 50);
      });
      var ro = (window.ResizeObserver && new ResizeObserver(updateTitleEmoji));
      var containerEl = document.querySelector('.form-container');
      if (ro && containerEl) ro.observe(containerEl);
    })();

    function checkDuplicatePlayers() {
      var whitePlayer = document.getElementById('whitePlayer').value;
      var blackPlayer = document.getElementById('blackPlayer').value;
      var whiteHelp = document.getElementById('white-help');
      var blackHelp = document.getElementById('black-help');

      // Clear any existing error messages
      if (whiteHelp) {
        whiteHelp.classList.remove('show', 'error');
        whiteHelp.textContent = 'Required field. Who played white?';
      }
      if (blackHelp) {
        blackHelp.classList.remove('show', 'error');
        blackHelp.textContent = 'Required field. Who played black?';
      }

      // Check if same core player selected for both colors (but allow Other + Other)
      if (whitePlayer && blackPlayer &&
        whitePlayer === blackPlayer &&
        whitePlayer !== 'Other' &&
        appConfig.players.indexOf(whitePlayer) !== -1) {
        if (whiteHelp) {
          whiteHelp.textContent = '‚ùå Same player cannot be both white and black';
          whiteHelp.classList.add('show', 'error');
        }
        if (blackHelp) {
          blackHelp.textContent = '‚ùå Same player cannot be both white and black';
          blackHelp.classList.add('show', 'error');
        }
      }

      // Update winner dropdown when players change
      updateWinnerDropdown();
    }

    function updateWinnerDropdown() {
      var whitePlayer = document.getElementById('whitePlayer').value;
      var blackPlayer = document.getElementById('blackPlayer').value;
      var winnerDropdown = document.getElementById('winner');
      var currentSelection = winnerDropdown.value;

      // Clear existing options except Draw
      winnerDropdown.innerHTML = '<option value="">winner</option><option value="Draw">Draw</option>';

      // Get actual player names (handle "Other" option)
      var whitePlayerName = whitePlayer;
      var blackPlayerName = blackPlayer;

      if (whitePlayer === 'Other') {
        var otherWhiteInput = document.getElementById('otherWhitePlayer');
        whitePlayerName = otherWhiteInput.value.trim() || 'White Player';
      }

      if (blackPlayer === 'Other') {
        var otherBlackInput = document.getElementById('otherBlackPlayer');
        blackPlayerName = otherBlackInput.value.trim() || 'Black Player';
      }

      // Add player options if players are selected
      if (whitePlayer) {
        var whiteOption = document.createElement('option');
        whiteOption.value = 'White';
        whiteOption.textContent = whitePlayerName + ' (White)';
        winnerDropdown.insertBefore(whiteOption, winnerDropdown.lastElementChild);
      }

      if (blackPlayer) {
        var blackOption = document.createElement('option');
        blackOption.value = 'Black';
        blackOption.textContent = blackPlayerName + ' (Black)';
        winnerDropdown.insertBefore(blackOption, winnerDropdown.lastElementChild);
      }

      // Restore previous selection if still valid
      if (currentSelection && (currentSelection === 'Draw' ||
        (currentSelection === 'White' && whitePlayer) ||
        (currentSelection === 'Black' && blackPlayer))) {
        winnerDropdown.value = currentSelection;
      }

      // Sync gameEnding options based on current winner selection
      try { onWinnerChange(); } catch (e) { /* ignore */ }
    }

    function onWinnerChange() {
      var winner = document.getElementById('winner').value;
      var gameEnding = document.getElementById('gameEnding');
      if (!gameEnding) return;

      // Draw-only endings
      var drawOptions = [
        { v: 'Stalemate', t: 'Stalemate' },
        { v: 'Insufficient Material', t: 'Insufficient Material' },
        { v: 'Threefold Repetition', t: 'Threefold Repetition' },
        { v: '50-Move Rule', t: '50-Move Rule' },
        { v: 'Agreement', t: 'Mutual Agreement' }
      ];

      // Non-draw endings
      var nonDrawOptions = [
        { v: 'Checkmate', t: 'Checkmate' },
        { v: 'Resignation', t: 'Resignation' },
        { v: 'Time Out', t: 'Time Out' }
      ];

      var previous = gameEnding.value;
      // Rebuild options
      var optionsHtml = '<option value="">Ending</option>';
      if (winner === 'Draw') {
        drawOptions.forEach(function (o) { optionsHtml += '<option value="' + o.v + '">' + o.t + '</option>'; });
      } else {
        nonDrawOptions.forEach(function (o) { optionsHtml += '<option value="' + o.v + '">' + o.t + '</option>'; });
      }
      gameEnding.innerHTML = optionsHtml;

      // Restore previous value if it's still present, otherwise clear
      var found = false;
      for (var i = 0; i < gameEnding.options.length; i++) {
        if (gameEnding.options[i].value === previous) { found = true; break; }
      }
      gameEnding.value = found ? previous : '';
    }

    function handleSubmit(event) {
      event.preventDefault();

      console.log('Form submission started');
      console.log('typeof google:', typeof google);
      console.log('google.script exists:', typeof google !== 'undefined' && google.script);
      console.log('google.script.run exists:', typeof google !== 'undefined' && google.script && google.script.run);

      // Check if google.script.run is available
      if (typeof google === 'undefined') {
        alert('‚ùå Google Apps Script not loaded. Please ensure you are accessing this form from the deployed Web App URL.');
        return false;
      }

      if (!google.script) {
        alert('‚ùå Google Apps Script API not available. Please try refreshing the page or using a different browser.');
        return false;
      }

      if (!google.script.run) {
        alert('‚ùå Google Apps Script run function not available. Please try refreshing the page.');
        return false;
      }

      // Basic validation
      var whitePlayer = document.getElementById('whitePlayer').value;
      var blackPlayer = document.getElementById('blackPlayer').value;
      var winner = document.getElementById('winner').value;
      var gameEnding = document.getElementById('gameEnding').value;
      var venue = document.getElementById('venue').value.trim();

      // Hide all error messages first
      var helpTexts = document.querySelectorAll('.help-text');
      for (var i = 0; i < helpTexts.length; i++) {
        helpTexts[i].classList.remove('show', 'error');
      }

      var hasErrors = false;

      if (!whitePlayer) {
        var whiteHelp = document.getElementById('white-help');
        if (whiteHelp) {
          whiteHelp.textContent = '‚ùå Please select white player';
          whiteHelp.classList.add('show', 'error');
        }
        hasErrors = true;
      }

      if (!blackPlayer) {
        var blackHelp = document.getElementById('black-help');
        if (blackHelp) {
          blackHelp.textContent = '‚ùå Please select black player';
          blackHelp.classList.add('show', 'error');
        }
        hasErrors = true;
      }

      // Check if same core player selected for both colors
      // Allow Other + Other since they can be different people
      if (whitePlayer && blackPlayer &&
        whitePlayer === blackPlayer &&
        whitePlayer !== 'Other' &&
        appConfig.players.indexOf(whitePlayer) !== -1) {
        var whiteHelp = document.getElementById('white-help');
        var blackHelp = document.getElementById('black-help');
        if (whiteHelp) {
          whiteHelp.textContent = '‚ùå Same player cannot be both white and black';
          whiteHelp.classList.add('show', 'error');
        }
        if (blackHelp) {
          blackHelp.textContent = '‚ùå Same player cannot be both white and black';
          blackHelp.classList.add('show', 'error');
        }
        hasErrors = true;
      }

      if (!winner) {
        var winnerHelp = document.getElementById('winner-help');
        if (winnerHelp) {
          winnerHelp.textContent = '‚ùå Please select winner';
          winnerHelp.classList.add('show', 'error');
        }
        hasErrors = true;
      }

      if (!gameEnding) {
        var endingHelp = document.getElementById('ending-help');
        if (endingHelp) {
          endingHelp.textContent = '‚ùå Please select how game ended';
          endingHelp.classList.add('show', 'error');
        }
        hasErrors = true;
      }

      // Venue is now optional, so no validation needed

      // Check if Other venue is selected but no text provided
      if (venue === 'Other') {
        var otherVenue = document.getElementById('otherVenue').value.trim();
        if (!otherVenue) {
          var otherVenueHelp = document.getElementById('other-venue-help');
          if (otherVenueHelp) {
            otherVenueHelp.textContent = '‚ùå Please enter venue name';
            otherVenueHelp.classList.add('show', 'error');
          }
          hasErrors = true;
        }
      }

      // Check if Other white player is selected but no text provided
      if (whitePlayer === 'Other') {
        var otherWhitePlayer = document.getElementById('otherWhitePlayer').value.trim();
        if (!otherWhitePlayer) {
          var otherWhiteHelp = document.getElementById('other-white-help');
          if (otherWhiteHelp) {
            otherWhiteHelp.textContent = '‚ùå Please enter white player name';
            otherWhiteHelp.classList.add('show', 'error');
          }
          hasErrors = true;
        }
      }

      // Check if Other black player is selected but no text provided
      if (blackPlayer === 'Other') {
        var otherBlackPlayer = document.getElementById('otherBlackPlayer').value.trim();
        if (!otherBlackPlayer) {
          var otherBlackHelp = document.getElementById('other-black-help');
          if (otherBlackHelp) {
            otherBlackHelp.textContent = '‚ùå Please enter black player name';
            otherBlackHelp.classList.add('show', 'error');
          }
          hasErrors = true;
        }
      }

      // Check if Time Limit is required when Match Ending is Time Out
      var timeLimitMinutes = document.getElementById('timeLimitMinutes').value;
      var timeLimitSeconds = document.getElementById('timeLimitSeconds').value;
      var hasTimeLimit = timeLimitMinutes !== '' || timeLimitSeconds !== '';
      var timeLimitHelp = document.getElementById('time-limit-help');

      if (gameEnding === 'Time Out' && !hasTimeLimit) {
        if (timeLimitHelp) {
          timeLimitHelp.textContent = '‚ùå Time limit required for Time Out ending';
          timeLimitHelp.classList.add('show', 'error');
        }
        hasErrors = true;
      }

      // Check if timed game is under 1 minute (only when time limit is set)
      if (hasTimeLimit) {
        var totalSeconds = (parseInt(timeLimitMinutes) || 0) * 60 + (parseInt(timeLimitSeconds) || 0);
        if (totalSeconds < 60) {
          if (timeLimitHelp) {
            timeLimitHelp.textContent = '‚ùå Timed games must be at least 1 minute';
            timeLimitHelp.classList.add('show', 'error');
          }
          hasErrors = true;
        }
      }

      if (hasErrors) {
        return false;
      }

      // Show loading state
      var submitBtn = document.querySelector('.submit-btn');
      submitBtn.textContent = 'Saving to Google Sheets...';
      submitBtn.disabled = true;
      submitBtn.style.opacity = '0.7';

      console.log('Calling addRow function...');

      // Prepare form data array
      var actualVenue = venue === 'Other' ? document.getElementById('otherVenue').value.trim() : venue;
      var actualWhitePlayer = whitePlayer === 'Other' ? document.getElementById('otherWhitePlayer').value.trim() : whitePlayer;
      var actualBlackPlayer = blackPlayer === 'Other' ? document.getElementById('otherBlackPlayer').value.trim() : blackPlayer;

      // Handle picture upload
      var pictureFile = document.getElementById('picture').files[0];
      var pictureData = '';

      if (pictureFile) {
        // Convert image to base64 for storage
        var reader = new FileReader();
        reader.onload = function (e) {
          pictureData = e.target.result; // This includes the data:image/jpeg;base64, prefix
          submitFormWithData();
        };
        reader.readAsDataURL(pictureFile);
      } else {
        submitFormWithData();
      }

      function submitFormWithData() {
        var formData = [
          actualWhitePlayer,
          actualBlackPlayer,
          winner,
          gameEnding,
          (function () {
            var minutes = document.getElementById('timeLimitMinutes').value;
            var seconds = document.getElementById('timeLimitSeconds').value;
            if (minutes === '' && seconds === '') return '';
            return (minutes || '0') + ':' + (seconds || '00').padStart(2, '0');
          })(),
          actualVenue,
          document.getElementById('brutality').value,
          document.getElementById('notes').value,
          pictureData,
          document.getElementById('whiteMulligan').checked ? 'Yes' : 'No',
          document.getElementById('blackMulligan').checked ? 'Yes' : 'No'
        ];

        try {
          var timeoutId = setTimeout(function () {
            console.error('Google Apps Script call timed out');
            alert('‚ùå Request timed out. Please check your internet connection and try again.');

            var submitBtn = document.querySelector('.submit-btn');
            submitBtn.textContent = 'Log Chess Game';
            submitBtn.disabled = false;
            submitBtn.style.opacity = '1';
          }, 30000);

          google.script.run
            .withSuccessHandler(function (result) {
              clearTimeout(timeoutId);
              onSubmitSuccess(result);
            })
            .withFailureHandler(function (error) {
              clearTimeout(timeoutId);
              console.error('Google Apps Script error:', error);
              onSubmitError(error);
            })
            .addRow(formData);

          console.log('Google Apps Script call initiated successfully');

        } catch (error) {
          console.error('Error calling google.script.run:', error);
          alert('‚ùå JavaScript error submitting form: ' + error.message + '. Please try refreshing the page.');

          var submitBtn = document.querySelector('.submit-btn');
          submitBtn.textContent = 'Log Chess Game';
          submitBtn.disabled = false;
          submitBtn.style.opacity = '1';
        }
      }

      return false;
    }

    function onSubmitSuccess(result) {
      var helpTexts = document.querySelectorAll('.help-text');
      for (var i = 0; i < helpTexts.length; i++) {
        helpTexts[i].classList.remove('show', 'error');
      }

      var submitBtn = document.querySelector('.submit-btn');
      submitBtn.textContent = '‚úÖ Match Logged Successfully!';
      submitBtn.style.background = '#10b981';

      // Reset form
      document.querySelector('form').reset();

      // Reset brutality slider and other fields
      updateBrutalitySlider('');
      toggleOtherVenue('');
      toggleOtherPlayer('white', '');
      toggleOtherPlayer('black', '');

      // Reset and hide mulligan section
      document.getElementById('whiteMulligan').checked = false;
      document.getElementById('blackMulligan').checked = false;
      document.getElementById('mulliganSection').style.display = 'none';

      setTimeout(function () {
        submitBtn.textContent = 'Log Match';
        submitBtn.style.background = 'linear-gradient(135deg, #00d4ff 0%, #7c3aed 50%, #10b981 100%)';
        submitBtn.disabled = false;
        submitBtn.style.opacity = '1';

        // Refresh session display and dropdown after successful submission
        loadSessionDropdown();
        loadCurrentSession();

        document.getElementById('whitePlayer').focus();
      }, 2000);
    }

    function onSubmitError(error) {
      alert('‚ùå Error: ' + error.message);

      var submitBtn = document.querySelector('.submit-btn');
      submitBtn.textContent = 'Log Chess Game';
      submitBtn.disabled = false;
      submitBtn.style.opacity = '1';

      console.error('Submit error:', error);
    }

    // Make functions globally accessible
    window.selectResult = selectResult;
    window.handleSubmit = handleSubmit;
    window.onSubmitSuccess = onSubmitSuccess;
    window.onSubmitError = onSubmitError;
    window.updateBrutalitySlider = updateBrutalitySlider;
    window.toggleOtherVenue = toggleOtherVenue;
    window.toggleOtherPlayer = toggleOtherPlayer;
    window.checkDuplicatePlayers = checkDuplicatePlayers;
    window.updateWinnerDropdown = updateWinnerDropdown;
    window.toggleCheckbox = toggleCheckbox;
    window.toggleMulliganSection = toggleMulliganSection;
    window.updateMulliganLabels = updateMulliganLabels;

    // ===== Current Session Display Functions =====

    /**
     * Load all sessions and populate dropdown
     */
    function loadSessionDropdown() {
      google.script.run
        .withSuccessHandler(function(sessions) {
          console.log('Loaded sessions:', sessions);

          var selector = document.getElementById('session-selector');

          // Clear existing options except the first one (Current Session)
          while (selector.options.length > 1) {
            selector.remove(1);
          }

          // Add session options
          if (sessions && sessions.length > 0) {
            sessions.forEach(function(session) {
              var option = document.createElement('option');
              option.value = session.id;

              // Format the option text: "1/27 Tue Night Fortaleza del..."
              var startDate = new Date(session.startTime);
              var dateStr = (startDate.getMonth() + 1) + '/' + startDate.getDate();
              var dayOfWeek = getDayOfWeek(startDate);
              var timeOfDay = getTimeOfDay(startDate);

              // Truncate venue if too long
              var venue = session.venue;
              if (venue.length > 20) {
                venue = venue.substring(0, 20) + '...';
              }

              option.textContent = dateStr + ' ' + dayOfWeek + ' ' + timeOfDay + ' ' + venue;
              selector.appendChild(option);

              console.log('Added session option:', session.id, option.textContent);
            });
          }
        })
        .withFailureHandler(function(err) {
          console.error('Failed to load sessions:', err);
        })
        .getAllSessions();
    }

    /**
     * Handle session dropdown change
     */
    function onSessionChange() {
      var selector = document.getElementById('session-selector');
      console.log('Session changed to:', selector.value, selector.selectedIndex);
      loadCurrentSession();
    }

    /**
     * Load current session data from server and display
     */
    function loadCurrentSession(event) {
      if (event) {
        event.stopPropagation(); // Prevent toggle when clicking refresh
      }

      // Get selected session ID from dropdown
      var selector = document.getElementById('session-selector');
      var selectedSessionId = selector.value || null;

      console.log('Loading session with ID:', selectedSessionId);

      // Show loading state
      var loading = document.getElementById('session-loading');
      var data = document.getElementById('session-data');
      var noData = document.getElementById('session-no-data');
      var error = document.getElementById('session-error');
      var refreshBtn = document.getElementById('refresh-session-btn');

      loading.style.display = 'block';
      data.style.display = 'none';
      noData.style.display = 'none';
      error.style.display = 'none';
      refreshBtn.disabled = true;

      google.script.run
        .withSuccessHandler(function(sessionData) {
          console.log('Received session data:', sessionData);

          loading.style.display = 'none';
          refreshBtn.disabled = false;

          if (!sessionData) {
            console.log('No session data returned');
            noData.style.display = 'block';
            return;
          }

          // Populate session metadata
          document.getElementById('session-venue').textContent = sessionData.venue || 'Unknown';
          document.getElementById('session-match-count').textContent = sessionData.matchCount || 0;

          // Format start time
          if (sessionData.startTime) {
            var startDate = new Date(sessionData.startTime);
            var now = new Date();
            var diffMs = now - startDate;
            var diffMins = Math.floor(diffMs / 60000);
            var duration = formatDuration(diffMins);

            document.getElementById('session-start-time').textContent = formatTime(startDate);
            document.getElementById('session-duration').textContent = duration + ' ago';
          }

          // Populate player stats table
          populateStatsTable(sessionData.playerStats);

          // Format session summary
          formatSessionSummary(sessionData);

          data.style.display = 'block';
        })
        .withFailureHandler(function(err) {
          loading.style.display = 'none';
          error.style.display = 'block';
          refreshBtn.disabled = false;
          console.error('Failed to load session data:', err);
        })
        .getCurrentSessionData(selectedSessionId);
    }

    /**
     * Toggle session display collapsed/expanded
     */
    function toggleSessionDisplay() {
      var content = document.getElementById('session-content');
      content.classList.toggle('collapsed');
    }

    /**
     * Populate player stats table with data
     */
    function populateStatsTable(playerStats) {
      var tbody = document.getElementById('session-stats-body');
      tbody.innerHTML = '';

      if (!playerStats || playerStats.length === 0) {
        var row = tbody.insertRow();
        var cell = row.insertCell(0);
        cell.colSpan = 7;
        cell.textContent = 'No player stats available';
        cell.style.textAlign = 'center';
        cell.style.fontStyle = 'italic';
        cell.style.color = 'rgba(248, 249, 250, 0.5)';
        return;
      }

      // Sort by wins descending
      playerStats.sort(function(a, b) {
        return b.wins - a.wins;
      });

      playerStats.forEach(function(stat) {
        var row = tbody.insertRow();
        row.insertCell(0).textContent = stat.player;
        row.insertCell(1).textContent = stat.matches;
        row.insertCell(2).textContent = stat.wins;
        row.insertCell(3).textContent = stat.losses;
        row.insertCell(4).textContent = stat.draws;
        row.insertCell(5).textContent = stat.inflicted;
        row.insertCell(6).textContent = stat.suffered;
      });
    }

    /**
     * Format last match text
     */
    function formatLastMatchText(lastMatch) {
      if (!lastMatch) return;

      var matchDate = new Date(lastMatch.timestamp);
      var timeSince = formatTimeSince(matchDate);
      var resultText = '';

      if (lastMatch.winner === 'Draw') {
        resultText = lastMatch.whitePlayer + ' (White) drew with ' + lastMatch.blackPlayer + ' (Black)';
      } else {
        var winner = (lastMatch.winner === 'White') ? lastMatch.whitePlayer : lastMatch.blackPlayer;
        var loser = (lastMatch.winner === 'White') ? lastMatch.blackPlayer : lastMatch.whitePlayer;
        resultText = winner + ' (' + lastMatch.winner + ') defeated ' + loser;
      }

      document.getElementById('session-last-match-text').textContent =
        'Last match: ' + resultText + ' ‚Äî ' + timeSince;
    }

    /**
     * Format time as "3:45 PM"
     */
    function formatTime(date) {
      var hours = date.getHours();
      var minutes = date.getMinutes();
      var ampm = hours >= 12 ? 'PM' : 'AM';
      hours = hours % 12;
      hours = hours ? hours : 12;
      minutes = minutes < 10 ? '0' + minutes : minutes;
      return hours + ':' + minutes + ' ' + ampm;
    }

    /**
     * Format duration in minutes as "2h 30m" or "45 mins"
     */
    function formatDuration(minutes) {
      if (minutes < 60) {
        return minutes + ' min' + (minutes !== 1 ? 's' : '');
      }
      var hours = Math.floor(minutes / 60);
      var mins = minutes % 60;
      return hours + 'h ' + mins + 'm';
    }

    /**
     * Format time since as "just now", "15 mins ago", etc.
     */
    function formatTimeSince(date) {
      var now = new Date();
      var diffMs = now - date;
      var diffMins = Math.floor(diffMs / 60000);

      if (diffMins < 1) return 'just now';
      if (diffMins < 60) return diffMins + ' min' + (diffMins !== 1 ? 's' : '') + ' ago';

      var diffHours = Math.floor(diffMins / 60);
      if (diffHours < 24) {
        var mins = diffMins % 60;
        return diffHours + 'h ' + mins + 'm ago';
      }

      return 'over a day ago';
    }

    /**
     * Get day of week abbreviation (Mon, Tue, Wed, etc.)
     */
    function getDayOfWeek(date) {
      var days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      return days[date.getDay()];
    }

    /**
     * Get time of day (Morning, Afternoon, Evening, Night)
     */
    function getTimeOfDay(date) {
      var hour = date.getHours();
      if (hour >= 5 && hour < 12) return 'Morning';
      if (hour >= 12 && hour < 17) return 'Afternoon';
      if (hour >= 17 && hour < 21) return 'Evening';
      return 'Night';
    }

    // ===== End Current Session Display Functions =====

    // Mobile browser compatibility check
    function checkGoogleScriptAvailability() {
      setTimeout(function () {
        if (typeof google === 'undefined' || !google.script || !google.script.run) {
          console.warn('Google Apps Script API not fully loaded. This may affect form submission on mobile browsers.');
        } else {
          console.log('Google Apps Script API loaded successfully');
        }
      }, 3000);
    }

    // Initialize brutality slider on page load
    updateBrutalitySlider(0);

    checkGoogleScriptAvailability();

    // Load current session data and populate dropdown on page load
    window.addEventListener('load', function() {
      loadSessionDropdown();
      loadCurrentSession();
    });
  </script>
</body>

</html>